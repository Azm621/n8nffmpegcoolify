version: "3.8"

services:
  n8n:
    image: rxchi1d/n8n-ffmpeg:latest
    container_name: n8n
    restart: unless-stopped

    environment:
      # Basic n8n config
      - N8N_HOST=${N8N_HOST}
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - N8N_TRUST_PROXY=true

      # Database
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=${DB_PASSWORD}

      # Security keys
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

      # Binary data
      - N8N_BINARY_DATA_MODE=filesystem
      - N8N_BINARY_DATA_STORAGE_PATH=/home/node/.n8n/binaryData

      # Timezone
      - TZ=UTC
      - GENERIC_TIMEZONE=UTC

    volumes:
      - n8n-data:/home/node/.n8n

    depends_on:
      - postgres

  postgres:
    image: postgres:15-alpine
    container_name: n8n-postgres
    restart: unless-stopped

    environment:
      - POSTGRES_DB=n8n
      - POSTGRES_USER=n8n
      - POSTGRES_PASSWORD=${DB_PASSWORD}

    volumes:
      - pg-data:/var/lib/postgresql/data

volumes:
  n8n-data:
  pg-data:
